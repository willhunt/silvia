<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Temperature Control | Silviabot Documentation</title>
    <meta name="generator" content="VuePress 1.5.2">
    
    <meta name="description" content="Silviabot smart espresso machine">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="preload" href="/silvia/assets/css/0.styles.84c15d8c.css" as="style"><link rel="preload" href="/silvia/assets/js/app.58b51180.js" as="script"><link rel="preload" href="/silvia/assets/js/2.216158cf.js" as="script"><link rel="preload" href="/silvia/assets/js/13.90f118ae.js" as="script"><link rel="preload" href="/silvia/assets/js/3.f01c0106.js" as="script"><link rel="prefetch" href="/silvia/assets/js/10.1d3113f7.js"><link rel="prefetch" href="/silvia/assets/js/11.e3890126.js"><link rel="prefetch" href="/silvia/assets/js/12.6ae84a4f.js"><link rel="prefetch" href="/silvia/assets/js/14.e55e6256.js"><link rel="prefetch" href="/silvia/assets/js/15.85a719c5.js"><link rel="prefetch" href="/silvia/assets/js/16.135070dd.js"><link rel="prefetch" href="/silvia/assets/js/17.b37ec67f.js"><link rel="prefetch" href="/silvia/assets/js/18.10500e0d.js"><link rel="prefetch" href="/silvia/assets/js/19.9a8bea67.js"><link rel="prefetch" href="/silvia/assets/js/20.2b4676e2.js"><link rel="prefetch" href="/silvia/assets/js/21.d7a4d73e.js"><link rel="prefetch" href="/silvia/assets/js/22.6c7c5b00.js"><link rel="prefetch" href="/silvia/assets/js/23.ad97dde0.js"><link rel="prefetch" href="/silvia/assets/js/4.02721f6a.js"><link rel="prefetch" href="/silvia/assets/js/5.267c1543.js"><link rel="prefetch" href="/silvia/assets/js/6.6da585be.js"><link rel="prefetch" href="/silvia/assets/js/7.05a1fa71.js"><link rel="prefetch" href="/silvia/assets/js/8.4531bd28.js"><link rel="prefetch" href="/silvia/assets/js/9.fedc342e.js">
    <link rel="stylesheet" href="/silvia/assets/css/0.styles.84c15d8c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/silvia/" class="home-link router-link-active"><!----> <span class="site-name">Silviabot Documentation</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/silvia/demo/" class="nav-link">
  Demo
</a></div><div class="nav-item"><a href="/silvia/setup/" class="nav-link">
  Setup
</a></div><div class="nav-item"><a href="/silvia/build/" class="nav-link router-link-active">
  Build
</a></div><div class="nav-item"><a href="https://github.com/willhunt/silvia" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/silvia/demo/" class="nav-link">
  Demo
</a></div><div class="nav-item"><a href="/silvia/setup/" class="nav-link">
  Setup
</a></div><div class="nav-item"><a href="/silvia/build/" class="nav-link router-link-active">
  Build
</a></div><div class="nav-item"><a href="https://github.com/willhunt/silvia" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Build</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/silvia/build/" aria-current="page" class="sidebar-link">Introduction</a></li><li><a href="/silvia/build/temperature-control.html" aria-current="page" class="active sidebar-link">Temperature Control</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/silvia/build/temperature-control.html#components" class="sidebar-link">Components</a></li><li class="sidebar-sub-header"><a href="/silvia/build/temperature-control.html#installation" class="sidebar-link">Installation</a></li><li class="sidebar-sub-header"><a href="/silvia/build/temperature-control.html#wiring" class="sidebar-link">Wiring</a></li><li class="sidebar-sub-header"><a href="/silvia/build/temperature-control.html#software" class="sidebar-link">Software</a></li></ul></li><li><a href="/silvia/build/power-control.html" class="sidebar-link">Power Control</a></li><li><a href="/silvia/build/brew-control.html" class="sidebar-link">Brew Control</a></li><li><a href="/silvia/build/power-supply.html" class="sidebar-link">Power supply</a></li><li><a href="/silvia/build/oled-display.html" class="sidebar-link">Display</a></li><li><a href="/silvia/build/wifi-scale.html" class="sidebar-link">Wireless Scale</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="temperature-control"><a href="#temperature-control" class="header-anchor">#</a> Temperature Control</h1> <p>The stock Rancillio Silvia uses a thermostat to control the boiler heating element meaning that the temperature fluctuates by several degrees in cycles. PID control can be used with a solid state relay (SSR) to control the heater with much faster on/off cycles. This is a common modification to the this machine with several guides available online or as commercial kits, usually using an off the shelf temperature controller or Arduino for the more interested hobbyist. An Arduino is used for real time PID temperature control.  Unlike the raspberry pi it will operate consistently without interruption as well as having an analog to digital converter (ADC) for the temperature sensor.</p> <h2 id="components"><a href="#components" class="header-anchor">#</a> Components</h2> <ul><li>Clion HHG1-1/032F-38 Solid State Relay (Generic Chinese)
<ul><li>Control voltage range 3-32 VDC</li> <li>Output voltage range 24-440 VAC</li> <li>Output maximum load 25 A (Plenty)</li></ul></li> <li>LM35DT temperature sensor [<a href="https://www.ti.com/lit/ds/symlink/lm35.pdf" target="_blank" rel="noopener noreferrer">datasheet<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>]
<ul><li>−55°C to 150°C range</li> <li>0.5°C accuracy @ 25°C</li></ul></li></ul> <h2 id="installation"><a href="#installation" class="header-anchor">#</a> Installation</h2> <p>In line with other Rancillio Silvia mods the heat relay was fastened behind the front cover panel above the drip tray using the existing fastener for the cable clamp (on other side). This is enough to hold it in place but a second hole was drilled above to fix the relay securely in place. The temperature sensor was screwed down using a threaded hole for the original thermostat.</p> <div class="docs-image-layout" data-v-76cbf739><div data-v-76cbf739><div class="docs-image-item sm" data-v-39ccd7f2 data-v-76cbf739><div data-v-39ccd7f2><img src="/silvia/assets/build/build_temperature_01.jpg" data-v-39ccd7f2></div> <div class="caption" data-v-39ccd7f2>
    Temperature sensor mounted on boiler
  </div></div></div><div data-v-76cbf739><div class="docs-image-item sm" data-v-39ccd7f2 data-v-76cbf739><div data-v-39ccd7f2><img src="/silvia/assets/build/build_heatrelay_01.jpg" data-v-39ccd7f2></div> <div class="caption" data-v-39ccd7f2>
    Solid state heat relay
  </div></div></div></div> <h2 id="wiring"><a href="#wiring" class="header-anchor">#</a> Wiring</h2> <p>The Arduino controls the PID I/O independently of the raspberry pi although the pi, connected via i2C can turn the operation on and off as well as change the setpoint and gains. A 10kΩ pull-down resistor is used to ensure the relay input is at 0V when the output in not high.</p> <div class="docs-image-layout" data-v-76cbf739><div data-v-76cbf739><div class="docs-image-item lg" data-v-39ccd7f2 data-v-76cbf739><div data-v-39ccd7f2><img src="/silvia/assets/build/wiring_temperaturecontrol_01.png" data-v-39ccd7f2></div> <div class="caption" data-v-39ccd7f2>
    Fritzing wiring diagram for temperature control
  </div></div></div></div> <h2 id="software"><a href="#software" class="header-anchor">#</a> Software</h2> <h3 id="temperature-sensing"><a href="#temperature-sensing" class="header-anchor">#</a> Temperature sensing</h3> <p>To smooth the temperature readings a combination of averaging and a smoothing filter are used.</p> <p>Temperature readings are summed up over a time period, counting the quantity:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code>reading_sum <span class="token operator">+=</span> <span class="token function">analogRead</span><span class="token punctuation">(</span>sensor_pin<span class="token punctuation">)</span> <span class="token operator">*</span> sensor_coefficient<span class="token punctuation">;</span>
reading_count <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre></div><p>After a set time interval these are then averaged and smoothed with respect to the previous value. The smoothing filter value controls the magnitude of this effect by biasing the value more or less towards the previously stored temperature:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">float</span> average <span class="token operator">=</span> reading_sum <span class="token operator">/</span> reading_count<span class="token punctuation">;</span>
<span class="token comment">// Apply smoothing</span>
reading_new <span class="token operator">=</span> average <span class="token operator">*</span> smoothing_filter_val <span class="token operator">+</span> reading_last <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> smoothing_filter_val<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="pid"><a href="#pid" class="header-anchor">#</a> PID</h3> <p>For the PID control the Arduino PID library [<a href="https://github.com/br3ttb/Arduino-PID-Library/" target="_blank" rel="noopener noreferrer">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>] was used. To control the relay on/off output the technique was used as described in the <a href="https://playground.arduino.cc/Code/PIDLibraryRelayOutputExample/" target="_blank" rel="noopener noreferrer">relay example<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. This was wrapped up into a new class by inheriting from the libraries PID class, extending with the relay control function.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/silvia/build/" class="prev router-link-active">
        Introduction
      </a></span> <span class="next"><a href="/silvia/build/power-control.html">
        Power Control
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/silvia/assets/js/app.58b51180.js" defer></script><script src="/silvia/assets/js/2.216158cf.js" defer></script><script src="/silvia/assets/js/13.90f118ae.js" defer></script><script src="/silvia/assets/js/3.f01c0106.js" defer></script>
  </body>
</html>
