<!-- Load the Polymer.Element base class -->
<script src="../bower_components/webcomponentsjs/webcomponents-lite.js"></script>
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="vaadin-material-styles.html">

<dom-module id="swa-settings-view">
  <!-- Defines the element's style and local DOM -->
  <template>
    <style include="shared-styles iron-flex iron-flex-alignment">
      :host {
        display: block;

        padding: 16px;
      }
      .layout-item {
        padding-left: 20px;
        padding-right: 20px;
        padding-top: 6px;
        padding-bottom: 6px;
      }
      paper-card {
        min-width: 350px;
        max-width: 450px;
      }
    </style>

    <!--
      AJAX call to flask database via API to retrieve current settings
      Response stored in {{variable}} for use on page
    -->
    <div class="horizontal center-justified layout wrap">
      <iron-ajax auto
        id="requestSettings"
        url="/api/v1/settings/1"
        headers="[[_headers()]]"
        handle-as="json"
        on-response="handleApiResponse"
        last-response="{{apisettings}}">
      </iron-ajax>

      <paper-card heading="Settings">       
        <div class="card-content">
          <iron-form id="settingsForm">
            <form method="post" action="/api/v1/settings/1/">
              <div class="layout vertical">

                <div class="layout horizontal">     
                  <paper-input class="flex layout-item" id="set-temp" name="T_set" label="Boiler Temperature" value="{{apisettings.T_set}}"
                    auto-validate pattern="([0-9]|[1-8][0-9]|9[0-9]|1[0-4][0-9]|150)" error-message="0-150">
                    <div slot="suffix">&deg;C</div>
                  </paper-input>
                  <paper-input class="flex layout-item" id="set-flow" name="V" label="Brew Volume" value="{{apisettings.V}}"
                    auto-validate pattern="([0-9]|[1-8][0-9]|9[0-9]|[1-8][0-9]{2}|9[0-8][0-9]|99[0-9]|1000)" error-message="0-1000">
                    <div slot="suffix">ml</div>
                  </paper-input>
                </div>

                <div class="layout horizontal">
                  <paper-input class="flex layout-item" id="set-kp" name="k_p" label="Proportional Gain" value="{{apisettings.k_p}}"></paper-input>
                  <paper-input class="flex layout-item" id="set-kd" name="k_d" label="Derivative Gain" value="{{apisettings.k_d}}"></paper-input>
                  <paper-input class="flex layout-item" id="set-ki" name="k_i" label="Integral Gain" value="{{apisettings.k_i}}"></paper-input>
                </div>

                <div class="layout horizontal">     
                  <paper-input class="flex layout-item" id="set-t_sample" name="t_sample" label="Sampling Time" value="{{apisettings.t_sample}}"
                    auto-validate pattern="([0-9]|[1-5][0-9]|60)" error-message="0-60">
                    <div slot="suffix">s</div>
                  </paper-input>
                  <paper-input class="flex layout-item" id="set-t_update" name="t_update" label="Update Delay" value="{{apisettings.t_update}}"
                    auto-validate pattern="([0-9]|[1-5][0-9]|60)" error-message="0-60">
                    <div slot="suffix">s</div>
                  </paper-input>
                </div>

              </div>
            </form>
          </iron-form>         
        </div>
          
        <div class="card-actions horizontal end-justified layout">
          <paper-button raised class="primary" on-tap="_submit">Save</paper-button>
        </div> 
      </paper-card>
    </div>

  </template>

  <script>
    // Your new element extends the Polymer.Element base class
    class SwaSettingsView extends Polymer.Element {
      static get is() {
        return 'swa-settings-view';
      }

      _headers() {
        return {'X-CSRFToken': window.document.body.dataset.csrfToken};
      }
      
      handleApiResponse(apiresponse) {
        // Check api response for debugging
        console.log(apiresponse.detail.response);
      }

      connectedCallback() {
        super.connectedCallback();
        const settingsForm = this.$.settingsForm;

        settingsForm.addEventListener('iron-form-presubmit', function () {
          // Change request method to PUT as not naitively supported by HTML forms
          console.log('Pre-submit for settings form');
          this.request.method = 'put';
          var requestBody = this.request.body;
          // Change string (form) inputs to floats
          for (var name in requestBody) {
            if (typeof(requestBody[name]) == "string") {
              requestBody[name] = parseFloat(requestBody[name]);
            } 
          };
          this.request.contentType = "application/json";  // This didn't work setting in HTML
          console.log('Pre-submit request:', this.request.body);       
        });
      }

      _submit() {
        // Submit settings form
        console.log('Submitting settings form');
        this.$.settingsForm.submit();
      }
    }
    //Now, register your new custom element so the browser can use it
    customElements.define(SwaSettingsView.is, SwaSettingsView);
  </script>
</dom-module>
