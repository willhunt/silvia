<!-- Load the Polymer.Element base class -->
<script src="../bower_components/webcomponentsjs/webcomponents-lite.js"></script>
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="vaadin-material-styles.html">

<dom-module id="swa-schedule-view">
  <!-- Defines the element's style and local DOM -->
  <template>
    <style include="shared-styles iron-flex iron-flex-alignment">
      :host {
        display: block;
        padding: 16px;
      }
      .layout-item {
        padding: 15px;
      }
      .layout-block {
        margin-left: 5px;
        margin-right: 5px;
        margin-bottom: 10px;
      }
      paper-card {
        min-width: 350px;
        max-width: 450px;        
      }
      .centeritem {
        text-align: center;
        align-items: center;
      }
      .gridline {
        padding-top: 5px;
      }
      paper-fab {
        position: fixed;
        right: 25px;
        bottom: 30px;          
      }
      .time-input {
        width: 5em;
        --paper-input-container-input: {
            font-size: 1.4em;
            letter-spacing: 0.12em;
            text-align: center;
          };
      }
    </style>

    <!--
      AJAX call to flask database via API to retrieve current settings
      Response stored in {{variable}} for use on page
    -->
    <div class="horizontal center-justified layout wrap">
      <iron-ajax auto
        id="requestSchedules"
        url="/api/v1/schedules"
        handle-as="json"
        on-response="handleApiResponse"
        last-response="{{apischedules}}">
      </iron-ajax>
      <iron-ajax
        id="addSchedule"
        url="/api/v1/schedule"
        handle-as="json"
        method="put"
        on-response="handleApiResponse"
        last-response="{{apischedules}}">
      </iron-ajax>
      <iron-ajax
        id="deleteSchedule"
        url="{{urlDelete}}"
        handle-as="json"
        method="delete"
        on-response="handleApiResponse"
        last-response="{{apischedules}}">
      </iron-ajax>

      <!-- Loop over all schedule entries -->
      
      <dom-repeat items="[[apischedules]]"  id="scheduleRepeater">
        <template>
          <paper-card heading="Schedule [[item.id]]" class="layout-block" id="card[[item.id]]">       
            <div class="card-content">
              <iron-form id="scheduleForm[[item.id]]" data-id-schedule="[[item.id]]" on-iron-form-presubmit="_onIronFormPresubmit">
                <form method="post" action="/api/v2/schedule/[[item.id]]">
                  <div class="layout vertical">
                    <div class="layout horizontal around-justified">
                      <!--
                      <paper-time-input format="24" label="Turn On" name="t_on"
                            hour="{{_parseHour(item.t_on)}}" min="{{_parseMin(item.t_on)}}">
                      </paper-time-input>
                    -->
                      <paper-input name="t_on" label="Turn on" class="time-input"
                                    value="{{_parseTime(item.t_on)}}"
                                    allowed-pattern="[\d:]"
                                    pattern="([0-9]|0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]" 
                                    placeholder="00:00"
                                    error-message="HH:MM">
                      </paper-input>
                      <paper-input name="t_off" label="Turn off" class="time-input"
                                    value="{{_parseTime(item.t_off)}}"
                                    allowed-pattern="[\d:]"
                                    pattern="([0-9]|0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]" 
                                    placeholder="00:00"
                                    error-message="HH:MM">
                      </paper-input>
                      <paper-toggle-button id="active" checked="[[item.active]]"></paper-toggle-button>
                    </div>
                    <p></p>
                    <div class="layout horizontal around-justified">
                      <dom-repeat items=[[_strToBools(item.days)]]>
                        <template>
                            <paper-button toggles class="circle-toggle" active="[[item]]">
                              [[_getDay(index)]]
                            </paper-button>
                        </template>
                      </dom-repeat>

                    </div>
                  </div>
                </form>
              </iron-form>    
            </div>
              
            <div class="card-actions horizontal layout">
              <paper-icon-button icon="delete" on-tap="_deleteSchedule"></paper-icon-button>
              <div class="flex"></div>
              <paper-button raised class="primary" on-tap="_submit">Save</paper-button>
            </div> 
          </paper-card>
        </template>
      </dom-repeat>
       
      <paper-fab icon="add" title="new" on-tap="_addSchedule"></paper-fab>
    </div>

  </template>

  <script>
    // Your new element extends the Polymer.Element base class
    class SwaScheduleView extends Polymer.Element {
      static get is() {
        return 'swa-schedule-view';
      }

      static get properties() {
        return {
          urlDelete: {
            computed: 'computeUrl(idSchedule)',
          },
          idSchedule: {
            type: Number,
            notify: true,
          }
        }
      }

      handleApiResponse(apiresponse) {
        // Check api response for debugging
        console.log(apiresponse.detail.response);
      }

      connectedCallback() {
        super.connectedCallback();

      }

      // Code from response to my question here:
      //   https://stackoverflow.com/questions/51799425/
      _onIronFormPresubmit(e) {
        console.log('Pre-submit for schedule form');
        const ironForm = e.composedPath()[0];
        ironForm.request.method = 'put';
        //var requestBody = ironForm.request.body;
        
        // Add day selection to request
        var days = "";
        // Get all day elements
        const day_buttons = ironForm.querySelectorAll(".circle-toggle")
        day_buttons.forEach(day_button => {
          if (day_button.active) {
            days = days + 1;
          } else {
            days = days + 0;
          }
        });
        ironForm.request.body['days'] = days;

        // Add active selection to request (doesn't capture off mode in form ??)
        const active_toggle = ironForm.querySelector("#active");
        if (active_toggle.checked) {
          ironForm.request.body['active'] = true;
        } else {
          ironForm.request.body['active'] = false;
        }

        // Add form id to request
        //ironForm.request.body['id_schedule'] = ironForm.dataset.idSchedule;

        ironForm.request.contentType = "application/json";  // This didn't work setting in HTML
        console.log('Pre-submit request:', ironForm.request.body);       
  
      }

      _submit(e) {
        // Submit schedule form
        console.log('Submitting sechedule form');
        this.shadowRoot.querySelector('#scheduleForm' + e.model.item.id).submit();
      }

      _parseTime(t) {
        return t.substring(0, 5)
      }

      _strToBools(str) {
        var arr = [];
        for (var i = 0; i < str.length; i++) {
          if (str.charAt(i) == "1") {
            arr.push(true);
          } else {
            arr.push(false);
          }
        }
        return arr
      }

      _getDay(index_day) {
        const days="SMTWTFS";
        return days[index_day]
      }

      _addSchedule() {
        console.log("Adding new schedule")
        this.$.addSchedule.generateRequest();
      }
      _deleteSchedule(e) {
        console.log("Deleting schedule " + e.model.item.id);
        // Set id for api url
        this.idSchedule = e.model.item.id;
        // Animate card disappearing
        const card = this.shadowRoot.querySelector("#card" + e.model.item.id);
        const animation = card.animate(
          [
            { opacity: 1},
            { opacity: 0},
          ], {
            duration: 500,
            delay: 5,
            fill: "forwards",
        })
        animation.onfinish = () => {
          console.log("Sending delete request");
          this.$.deleteSchedule.generateRequest();
        }
      }

      computeUrl(idSchedule) {
        return ['/api/v2/schedule', idSchedule].join('/');
      }

      // Animations
      hideCardAnimation(id) {
        
      }
    }
    //Now, register your new custom element so the browser can use it
    customElements.define(SwaScheduleView.is, SwaScheduleView);
  </script>
</dom-module>
